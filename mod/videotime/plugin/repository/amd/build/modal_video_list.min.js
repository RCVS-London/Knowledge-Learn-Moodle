define("videotimeplugin_repository/modal_video_list",["jquery","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/templates","core/ajax","core/modal_factory","core/modal_events","core/str","videotimeplugin_repository/select2","videotimeplugin_repository/pagination"],(function($,Notification,CustomEvents,Modal,ModalRegistry,Templates,Ajax,ModalFactory,ModalEvents,str,select2,Pagination){var registered=!1,ModalVideoList=function(root){Modal.call(this,root),this.contextId=null,this.videos=[],this.videoPageIndex=[],this.descriptionModal=null,this.embedsModal=null,this.previewModal=null,this.confirmModal=null,this.query=null,this.filterData={},this.perPage=10,this.pagination=new Pagination(this.perPage,0,root),this.pagination.init(),this.sort=null,this.sortdirections={},this.readOnly=null};return ModalVideoList.TYPE="video-list",(ModalVideoList.prototype=Object.create(Modal.prototype)).constructor=ModalVideoList,ModalVideoList.prototype.init=function(){this.pagination.getContainer().on("pagination.changePage",function(){this.refreshTable()}.bind(this)),this.getConfirmModal((function(){})),this.getPreviewModal((function(){}))},ModalVideoList.prototype.setReadOnly=function(readOnly){this.readOnly=readOnly},ModalVideoList.prototype.setContextId=function(contextId){this.contextId=contextId},ModalVideoList.prototype.refreshTable=function(){let args={contextid:this.contextId,query:this.query,filter_data:this.filterData,limitfrom:this.pagination.getLimitFrom(),limitnum:this.perPage};this.sort&&(args.sort=this.sort,args.sortdirection=this.sortdirections[this.sort]),Ajax.call([{methodname:"videotimeplugin_repository_search_videos",args:args}])[0].done(function(response){response.data.forEach(function(item){this.videos[item.uri]=item,this.videoPageIndex[item.uri]=this.pagination.getCurrentPage()}.bind(this));let context=Object.assign(response,{readonly:this.readOnly});Templates.render("videotimeplugin_repository/video_table",context).then(function(html){this.pagination.setTotalItems(response.total),this.pagination.render("#pagination-container"),this.getRoot().find(".video-list-table").html(html)}.bind(this))}.bind(this))},ModalVideoList.prototype.registerEventListeners=function(){Modal.prototype.registerEventListeners.call(this),this.getRoot().on(ModalEvents.shown,function(){this.getModal().find(".select2").each(function(index,element){$(element).select2({dropdownParent:this.getRoot()})}.bind(this))}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=use-video]",function(e){this.showConfirmModal($(e.target).data("uri"))}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=show-description]",function(e){this.showDescriptionModal($(e.target).data("uri"))}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=show-embeds]",function(e){this.showEmbedsModal($(e.target).data("uri"))}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=preview]",function(e){this.showPreviewModal($(e.target).data("uri"))}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=search]",function(e){this.setQuery($($(e.target).data("target")).val())}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=clear-search]",function(e){this.query="",$($(e.target).data("target")).val(""),this.pagination.setCurrentPage(0),this.refreshTable()}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=apply-filters]",function(){this.applyFilters()}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=clear-filters]",function(e){this.filterData=[],$($(e.target).data("target")).val(""),this.getModal().find(".select2").val(null).trigger("change"),this.pagination.setCurrentPage(0),this.refreshTable()}.bind(this)),this.getModal().on(CustomEvents.events.activate,"[data-action=sort]",function(e){this.sort=$(e.target).data("field");let direction="ASC";this.sortdirections.hasOwnProperty(this.sort)&&(direction="ASC"==this.sortdirections[this.sort]?"DESC":"ASC"),this.sortdirections[this.sort]=direction,this.refreshTable()}.bind(this))},ModalVideoList.prototype.applyFilters=function(){this.filterData=this.getRoot().find("form").serializeArray(),this.pagination.setCurrentPage(0),this.refreshTable()},ModalVideoList.prototype.useVideo=function(videoUri,overrideSettings){var video=this.videos[videoUri];$("#id_vimeo_url").val(video.link),$("#id_vimeo_url").attr("readonly","readonly"),$("#id_choose_video").html(video.name),$("#id_choose_video").val(video.name),$("#id_choose_video").addClass("btn-success"),overrideSettings&&($("#id_name").val(video.name),$("#id_introeditor").val(video.description),$("#id_introeditoreditable").html(video.description),$("#id_completion_on_view_time_second").val(video.duration),$("#fitem_id_tags .form-autocomplete-selection").empty(),$("#fitem_id_tags #id_tags").empty(),$.each(video.tags,(function(index,tag){$("#fitem_id_tags #id_tags").append('<option data-iscustom="true" value="'+tag.name+'" selected>'+tag.name+"</option>"),$("#fitem_id_tags .form-autocomplete-selection").append('<span role="listitem" data-value="'+tag.name+'" aria-selected="true" class="label label-info"><span aria-hidden="true">Ã— </span>'+tag.name+"</span>")}))),this.hide()},ModalVideoList.prototype.showDescriptionModal=function(videoUri){if(this.videos.hasOwnProperty(videoUri)){var video=this.videos[videoUri];this.getDescriptionModal(function(modal){modal.setTitle(video.name),modal.setBody(video.description),modal.show()}.bind(this))}},ModalVideoList.prototype.getDescriptionModal=function(callback){this.descriptionModal?callback(this.descriptionModal):ModalFactory.create({}).done(function(modal){this.descriptionModal=modal,callback(this.descriptionModal)}.bind(this))},ModalVideoList.prototype.showEmbedsModal=function(videoUri){if(this.videos.hasOwnProperty(videoUri)){var video=this.videos[videoUri];str.get_string("embeds","videotime").done(function(string){this.getEmbedsModal(function(modal){modal.setTitle(video.name+" "+string),modal.setBody(Templates.render("videotimeplugin_repository/embeds",{video:video})),modal.show()}.bind(this))}.bind(this))}},ModalVideoList.prototype.getEmbedsModal=function(callback){this.embedsModal?callback(this.embedsModal):ModalFactory.create({}).done(function(modal){this.embedsModal=modal,callback(this.embedsModal)}.bind(this))},ModalVideoList.prototype.showPreviewModal=function(videoUri){if(this.videos.hasOwnProperty(videoUri)){var video=this.videos[videoUri];this.getPreviousAndNextVideoInSearch(videoUri).then(function(data){str.get_string("preview","moodle").done(function(string){this.getPreviewModal(function(modal){modal.setTitle(video.name+" "+string),modal.setBody(Templates.render("videotimeplugin_repository/preview_modal_body",{video:video,next_video:data.nextVideo,previous_video:data.previousVideo})),modal.show()}.bind(this))}.bind(this))}.bind(this))}},ModalVideoList.prototype.getPreviewModal=function(callback){this.previewModal?callback(this.previewModal):ModalFactory.create({large:!0,footer:Templates.render("videotimeplugin_repository/preview_modal_footer",{readonly:this.readOnly})}).done(function(modal){this.previewModal=modal,modal.getModal().on(CustomEvents.events.activate,"[data-action=use-video]",function(){modal.hide(),this.showConfirmModal(modal.getModal().find("#vimeo-embed").data("uri"))}.bind(this)),modal.getRoot().on(CustomEvents.events.activate,"[data-action=preview]",function(e){this.showPreviewModal($(e.target).data("uri"))}.bind(this)),callback(this.previewModal)}.bind(this))},ModalVideoList.prototype.getPreviousAndNextVideoInSearch=function(videoUri){let page=this.videoPageIndex[videoUri],limitfrom=0;page>0&&(limitfrom=page*this.perPage-1);let args={contextid:this.contextId,query:this.query,filter_data:this.filterData,limitfrom:limitfrom,limitnum:this.perPage+2};return this.sort&&(args.sort=this.sort,args.sortdirection=this.sortdirections[this.sort]),new Promise((resolve=>{Ajax.call([{methodname:"videotimeplugin_repository_search_videos",args:args}])[0].done(function(response){let previousVideo=null,nextVideo=null,last=null,useNext=!1;response.data.forEach(function(item,index){useNext&&(nextVideo=item,useNext=!1),item.uri===videoUri&&(previousVideo=last,useNext=!0),this.videos[item.uri]=item;let pageIndex=Math.floor((limitfrom+index)/this.perPage);this.videoPageIndex[item.uri]=pageIndex,last=item}.bind(this)),resolve({previousVideo:previousVideo,nextVideo:nextVideo})}.bind(this))}))},ModalVideoList.prototype.showConfirmModal=function(videoUri){if(this.videos.hasOwnProperty(videoUri)){var video=this.videos[videoUri];str.get_strings([{key:"confirmation",component:"videotime"},{key:"choose_video_confirm",component:"videotime"}]).done(function(strings){this.getConfirmModal(function(modal){modal.setTitle(strings[0]),modal.setBody("<p>"+strings[1]+' "'+video.name+'"?</p><input type="hidden" name="uri" value="'+video.uri+'">'),modal.show()}.bind(this))}.bind(this))}},ModalVideoList.prototype.getConfirmModal=function(callback){this.confirmModal?callback(this.confirmModal):ModalFactory.create({footer:Templates.render("videotimeplugin_repository/confirm_modal_footer",{readonly:this.readOnly})}).done(function(modal){this.confirmModal=modal,modal.getModal().on(CustomEvents.events.activate,"[data-action=use-video]",function(){modal.hide();var uri=modal.getModal().find("[name=uri]").val(),override=modal.getModal().find("[name=override]").prop("checked");this.useVideo(uri,override)}.bind(this)),callback(this.confirmModal)}.bind(this))},registered||(ModalRegistry.register(ModalVideoList.TYPE,ModalVideoList,"videotimeplugin_repository/modal_video_list"),registered=!0),ModalVideoList.prototype.setFilterValue=function(filterName,value){this.getRoot().find("[name="+filterName+"]").val(value).trigger("change")},ModalVideoList.prototype.setQuery=function(query){this.getRoot().find("#search-input").val(query),this.query=query,this.pagination.setCurrentPage(0),this.refreshTable()},ModalVideoList}));

//# sourceMappingURL=modal_video_list.min.js.map